@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import actions.SessionRequest
@import controllers.aboutYourLeaseOrTenure
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import models.submissions.aboutYourLeaseOrTenure.CheckYourAnswersAboutYourLeaseOrTenure
@import models.pages.Summary
@import util.DateUtil
@import util.DateUtil._
@import util.NumberUtil._
@import util.SectionAnswersRowBuilder

@this(layout: Layout,
        govukButton: GovukButton,
        govukRadios: GovukRadios,
        govukSummaryList: GovukSummaryList,
        dateUtil: DateUtil,
        formWithCSRF: FormWithCSRF
)

@(theForm: Form[CheckYourAnswersAboutYourLeaseOrTenure], backLink: String, summary: Summary)(implicit request: SessionRequest[_], messages: Messages)

@sectionAnswers = @{
    SectionAnswersRowBuilder(request.sessionData.aboutLeaseOrAgreementPartOne)
}

@sectionAnswers2 = @{
    SectionAnswersRowBuilder(request.sessionData.aboutLeaseOrAgreementPartTwo)
}

@layout(
    pageHeading = messages("checkYourAnswersAboutYourLeaseOrTenure.heading"),
    backLinkUrl = backLink,
    showSection = true,
    fullWidth = true,
    summary = Some(summary),
    sectionName = messages("label.section.aboutYourLeaseOrTenure"),
    theForm = theForm
) {

    @formWithCSRF(action = aboutYourLeaseOrTenure.routes.CheckYourAnswersAboutYourLeaseOrTenureController.submit()) {

        <h2 class="govuk-heading-m">@messages("checkYourAnswersAboutYourLeaseOrTenure.yourLandlord.heading")</h2>

        @govukSummaryList(SummaryList(rows =
            sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.landlordDetails",
                        _.aboutTheLandlord.map(l => s"<p class=\"govuk-body\">${l.landlordFullName}</p>${l.landlordAddress.escapedHtml}"),
                        aboutYourLeaseOrTenure.routes.AboutYourLandlordController.show(), "",
                        ("valueAsHtml", _ => None)) ++
                    sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.connectedToLandlord",
                        _.connectedToLandlord.map(_.name).map(v => messages(s"label.$v")),
                        aboutYourLeaseOrTenure.routes.ConnectedToLandlordController.show(), "connectedToLandlord") ++
                    sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.connectedToLandlordDetails",
                        _.connectedToLandlordDetails.map(_.connectedToLandlordInformationDetails),
                        aboutYourLeaseOrTenure.routes.ConnectedToLandlordDetailsController.show(), "connectedToLandlordDetails")
        ))

        @if(sectionAnswers.answers.exists(a => a.leaseOrAgreementYearsDetails.isDefined || a.currentRentPayableWithin12Months.isDefined)) {
            <h2 class="govuk-heading-m">@messages("checkYourAnswersAboutYourLeaseOrTenure.changesToYourLease.heading")</h2>

            @govukSummaryList(SummaryList(rows =
                sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.leaseOrAgreementDetails",
                    _.leaseOrAgreementYearsDetails
                            .map(l => (l.commenceWithinThreeYears.name, l.agreedReviewedAlteredThreeYears.name, l.rentUnderReviewNegotiated.name))
                            .map {
                        case (a, b, c) => Seq(messages(s"checkYourAnswersAboutYourLeaseOrTenure.commenceWithinThreeYears.$a"),
                            messages(s"checkYourAnswersAboutYourLeaseOrTenure.agreedReviewedAlteredThreeYears.$b"),
                            messages(s"checkYourAnswersAboutYourLeaseOrTenure.rentUnderReviewNegotiated.$c"))
                                .mkString("""<p class="govuk-body">""", """</p> <p class="govuk-body">""", "</p>")
                    },
                    aboutYourLeaseOrTenure.routes.LeaseOrAgreementYearsController.show(), "",
                    ("valueAsHtml", _ => None)) ++
                        sectionAnswers.optionalRow("checkYourAnswersAboutYourLeaseOrTenure.rentDueInNext12Months",
                            _.currentRentPayableWithin12Months.map(_.currentRentWithin12Months.name).map(v => messages(s"label.$v")),
                            aboutYourLeaseOrTenure.routes.CurrentRentPayableWithin12MonthsController.show(), "rentPayable") ++
                        sectionAnswers.optionalRow("checkYourAnswersAboutYourLeaseOrTenure.nextReviewOrExpiryDate",
                            _.currentRentPayableWithin12Months.map(_.rentActuallyAgreed.toYearMonth).map(dateUtil.formatYearMonth),
                            aboutYourLeaseOrTenure.routes.CurrentRentPayableWithin12MonthsController.show(), "dateReview.month")
            ))
        }

        @if(sectionAnswers.answers.exists(a => a.annualRent.isDefined || a.currentRentFirstPaid.isDefined || a.currentLeaseOrAgreementBegin.isDefined)) {
            <h2 class="govuk-heading-m">@messages("checkYourAnswersAboutYourLeaseOrTenure.leaseDetails.heading")</h2>

            @govukSummaryList(SummaryList(rows =
                sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.leasebackArrangement",
                    _.leasebackArrangement.map(_.name).map(v => messages(s"label.$v")),
                    Call("GET", "leaseback-arrangement"), "leasebackArrangement") ++ // TODO: Not implemented Controller for "leaseback-arrangement"
                        sectionAnswers.optionalRow("checkYourAnswersAboutYourLeaseOrTenure.currentAnnualRent",
                            _.annualRent.map(_.amount.asMoney),
                            aboutYourLeaseOrTenure.routes.CurrentAnnualRentController.show(), "currentAnnualRent") ++
                        sectionAnswers.optionalRow("checkYourAnswersAboutYourLeaseOrTenure.currentRentFirstPaid",
                            _.currentRentFirstPaid.map(_.currentRentFirstPaid.toYearMonth).map(dateUtil.formatYearMonth),
                            aboutYourLeaseOrTenure.routes.CurrentRentFirstPaidController.show(), "currentRentFirstPaid.month") ++
                        sectionAnswers2.optionalRow("checkYourAnswersAboutYourLeaseOrTenure.tenancyLeaseAgreementExpire",
                            _.tenancyLeaseAgreementExpire.map(_.tenancyLeaseAgreementExpire.shortDate),
                            aboutYourLeaseOrTenure.routes.TenancyLeaseAgreementExpireController.show(), "tenancyLeaseAgreementExpire.day") ++
                        sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.leaseStartDateAndDuration",
                            _.currentLeaseOrAgreementBegin
                                    .map(lease => s"${dateUtil.formatYearMonth(lease.leaseBegin.toYearMonth)}<br/>${lease.grantedFor} ${messages("suffix.grantedFor")}"),
                            aboutYourLeaseOrTenure.routes.CurrentLeaseOrAgreementBeginController.show(), "leaseBegin",
                            ("valueAsHtml", _ => None))
            ))
        }

        @if(sectionAnswers.answers.exists(a => a.includedInYourRentDetails.isDefined)) {
            <h2 class="govuk-heading-m">@messages("checkYourAnswersAboutYourLeaseOrTenure.whatRentIncludes.heading")</h2>

            @govukSummaryList(SummaryList(rows =
                sectionAnswers.row("checkYourAnswersAboutYourLeaseOrTenure.includedInYourRent",
                    _.includedInYourRentDetails.map(r =>
                        sectionAnswers.displayLabelsForYesAnswers(
                            Map("label.vat" -> r.vat.name, "label.nondomesticRates" -> r.nonDomesticRates.name, "label.waterCharges" -> r.waterCharges.name)
                        )
                    ),
                    aboutYourLeaseOrTenure.routes.IncludedInYourRentController.show(), "",
                    ("valueAsHtml", _ => None))
            ))
        }

        @includes.checkYourAnswersRadioButtons(
            govukRadios,
            theForm,
            "checkYourAnswersAboutYourLeaseOrTenure"
        )

        @includes.continueSaveAsDraftButtons(govukButton)

    }

}
