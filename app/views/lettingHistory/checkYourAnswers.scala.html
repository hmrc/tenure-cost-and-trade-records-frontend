@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import actions.SessionRequest
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import controllers.lettingHistory.routes
@import models.submissions.common.AnswersYesNo
@import util.SectionAnswersRowBuilder


@this(layout: Layout,
        govukButton: GovukButton,
        govukRadios: GovukRadios,
        formWithCSRF: FormWithCSRF,
        govukSummaryList: GovukSummaryList
)


@(theForm: Form[AnswersYesNo], backLink: String)(implicit request: SessionRequest[?], messages: Messages)

@lettingHistory = @{request.sessionData.lettingHistory}

@answers = @{
    SectionAnswersRowBuilder(request.sessionData.lettingHistory)
}

@booleanToYesNo(opt: Option[Boolean]) = @{
    opt match {
    case Some(true)  => messages("label.yes")
    case _           => messages("label.no")
 }
}

@pernamentResidentsListSize = @{
    lettingHistory.flatMap(_.permanentResidents).fold(0)(_.length)
}
@temporaryOccupiersListSize = @{
    lettingHistory.flatMap(_.completedLettings).fold(0)(_.length)
}
@advertisingOnlineListSize = @{
    lettingHistory.flatMap(_.onlineAdvertising).fold(0)(_.length)
}



@layout(
    pageHeading = messages("cya.lettingHistory.heading"),
    backLinkUrl = backLink,
    showSection = true,
    fullWidth = true,
    summary = Some(request.sessionData.toSummary),
    sectionName = messages("label.section.lettingHistory"),
    theForm = theForm
) {


    <h2 class="govuk-heading-m">@messages("cya.lettingHistory.residentialTenants.label")</h2>

    @govukSummaryList(SummaryList(rows =
        answers.row(
            "cya.lettingHistory.residentialTenants.question",
            _.hasPermanentResidents.fold("")(x => booleanToYesNo(x)),
            controllers.lettingHistory.routes.HasPermanentResidentsController.show,
            "answer",
            ("valueAsHtml", _ => None))


    ))

    @if(lettingHistory.flatMap(_.hasPermanentResidents.contains(true))) {

        @for((resident, idx) <- lettingHistory.flatMap(_.permanentResidents).getOrElse(IndexedSeq.empty).zipWithIndex) {

            @govukSummaryList(SummaryList(

            ))
        }
    }

    <h2 class="govuk-heading-m">@messages("cya.lettingHistory.temporaryOccupiers.label")</h2>

    @govukSummaryList(SummaryList(rows =
        answers.row(
            "cya.lettingHistory.temporaryOccupiers.question",
            _.hasCompletedLettings.fold("")(x => booleanToYesNo(x)),
            controllers.lettingHistory.routes.HasCompletedLettingsController.show,
            "answer",
            ("valueAsHtml", _ => None))
    ))

    <h2 class="govuk-heading-m">@messages("cya.lettingHistory.intention.label")</h2>


      @govukSummaryList(SummaryList(rows =
          answers.row(
              "cya.lettingHistory.intention.question",
              _.intendedLettings.map(_.nights).fold("")(x => s"${x.getOrElse("")} ${messages("cya.lettingHistory.intention.nights")}"),
              controllers.lettingHistory.routes.HowManyNightsController.show,
              "nights",
              ("valueAsHtml", _ => None)) ++
                  answers.conditionRow(
                      _.intendedLettings.flatMap(_.nights).exists(_ <= 139) && !request.sessionData.isWelsh, // English only !!!
                      "cya.lettingHistory.intention.stopped",
                      _.intendedLettings.map(_.hasStopped).fold("")(x => booleanToYesNo(x)),
                      controllers.lettingHistory.routes.HasStoppedLettingController.show,
                      "answer",
                      ("valueAsHtml", _ => None)) ++
                  answers.conditionRow(
                      (_.intendedLettings.flatMap(_.nights).exists(_ <= 251) && request.sessionData.isWelsh) , // Welsh only !!!
                      "cya.lettingHistory.intention.stopped",
                      _.intendedLettings.map(_.hasStopped).fold("")(x => booleanToYesNo(x)),
                      controllers.lettingHistory.routes.HasStoppedLettingController.show,
                      "answer",
                      ("valueAsHtml", _ => None)) ++
                  answers.conditionRow(
                      _.intendedLettings.flatMap(_.nights).exists(_ <= 139) && !request.sessionData.isWelsh, // English only !!!
                      "cya.lettingHistory.intention.final",
                      _.intendedLettings.map(_.whenWasLastLet).fold("")(x => x.toString),
                      controllers.lettingHistory.routes.WhenWasLastLetController.show,
                      "date",
                      ("valueAsHtml", _ => None)) ++
                  answers.conditionRow(
                      _.intendedLettings.flatMap(_.nights).exists(_ <= 251) && request.sessionData.isWelsh, // Welsh only
                      "cya.lettingHistory.intention.final",
                      _.intendedLettings.map(_.whenWasLastLet).fold("")(x => x.toString),
                      controllers.lettingHistory.routes.WhenWasLastLetController.show,
                      "date",
                      ("valueAsHtml", _ => None)) ++
                  answers.row(
                      "cya.lettingHistory.intention.availableFor",
                      _.intendedLettings.map(_.isYearlyAvailable).fold("")(x => booleanToYesNo(x)),
                      controllers.lettingHistory.routes.IsYearlyAvailableController.show,
                      "answer",
                      ("valueAsHtml", _ => None)) ++
                  answers.row(
                      "cya.lettingHistory.intention.seasonDetails",
                      _.intendedLettings.map(_.tradingPeriod).fold("")(x => x.getOrElse("").toString),
                      controllers.lettingHistory.routes.TradingSeasonLengthController.show,
                      "fromDate",
                      ("valueAsHtml", _ => None))

      ))

    <h2 class="govuk-heading-m">@messages("cya.lettingHistory.advertising.label")</h2>

    @govukSummaryList(SummaryList(rows =
        answers.row(
            "cya.lettingHistory.advertising.question",
            _.hasOnlineAdvertising.fold("")(x => booleanToYesNo(x)),
            controllers.lettingHistory.routes.AdvertisingOnlineController.show,
            "",
            ("valueAsHtml", _ => None))
    ))


    @formWithCSRF(action = routes.CheckYourAnswersController.submit) {

        @includes.checkYourAnswersRadioButtons(
            govukRadios,
            theForm,
            "cYALettingHistory"
        )

        @includes.continueSaveAsDraftButtons(govukButton)

    }
}